# 웹 통신의 큰 흐름

![웹 통신의 큰 흐름 마인드맵](웹통신_마인드맵.png)

> **https://www.google.com/** 을 접속할 때 일어나는 일

---

## 웹 통신 과정

### 1. 브라우저에 웹 주소 입력
사용자가 브라우저 주소창에 도메인명을 입력합니다.

### 2. IP 주소 획득 과정 (DNS 조회)
웹 서버에 접속하기 위해서는 도메인명을 IP 주소로 변환해야 합니다.

#### 2-1. DNS 질의 시작
브라우저는 DNS 서버에 질의를 시작합니다.

#### 2-2. DNS 캐시 확인 (우선순위)
DNS 서버에 질의하기 전에 다음 두 곳을 먼저 확인합니다:

1. **호스트 파일 (hosts file)** 확인
   - 해당 정보가 기록되어 있는지 확인
   
2. **운영체제 캐시 (OS Cache)** 확인
   - 이전에 질의한 값이 운영체제에 캐싱되어 있는지 확인

> 만약 이 두 곳에서 정보를 찾을 수 없을 시에 DNS(분산형 DB 구조)서버에 질의하게 됩니다.

#### 2-3. DNS 질의 방식
두 가지 방식이 있습니다:

- **직접 질의**: PC가 직접 DNS 서버에 질의
- **공유기 통한 질의**: 공유기를 통해 DNS 서버에 질의

**공유기가 DNS 서버로 지정된 경우:**
- PC의 DNS 설정이 공유기 자체의 사설 IP 주소로 지정
- 공유기는 사설망과 외부망 사이에서 게이트웨이 역할 수행
- 공유기는 DNS 포워딩(DNS forwarding) 기능을 통해 외부 DNS 서버로 쿼리 전달

### 3. IP 주소 획득
DNS 조회를 통해 목적지 서버의 IP 주소를 획득합니다.

### 4. TCP 연결 설정
획득한 IP 주소를 가지고 서버와 TCP 연결을 시작합니다.

> **왜 TCP 연결이 필요한가?** HTTP 통신을 기본으로 하기 때문에 TCP 연결이 필요합니다.

### 5. HTTP 요청 전송
TCP 통신이 성공하면 HTTP Request(요청)를 서버로 전송합니다.

### 6. HTTP 응답 수신
서버로부터 HTTP Response(응답)를 받습니다.

---

## 웹 통신 흐름도

```
사용자 브라우저 → DNS 조회 → IP 획득 → TCP 연결 → HTTP 요청 → HTTP 응답
     ↓              ↓           ↓         ↓          ↓          ↓
  URL 입력    호스트파일/캐시   DNS서버  3-way      GET/POST   HTML/CSS/JS
              확인 후 DNS      조회    handshake   요청       응답
```

## DNS 조회 과정 상세도

```
브라우저
   ↓
호스트 파일 확인
   ↓ (없으면)
OS 캐시 확인  
   ↓ (없으면)
DNS 서버 조회
   ↓
공유기 (DNS 포워딩)
   ↓
외부 DNS 서버
   ↓
IP 주소 반환
```

---

## URL과 URI의 차이

### 개념적 차이
- **URI**: 리소스를 식별하는 역할
- **URL**: 리소스의 위치를 지정하는 역할

### 관계와 예시
URL은 URI의 한 종류입니다.

**예시:**
- `google.com` → URI (이름만 나타냄)
- `https://google.com` → URL이면서 URI (프로토콜과 접근 방법/위치를 모두 포함)

> **질문**: 위치로 리소스를 식별하면 안 되는 건가?  
> **답변**: URL은 리소스를 식별하는 역할까지 수행합니다.

### 정리
- **URI** = URL + URN = 리소스를 이름, 위치 또는 둘 다를 통해 식별하는 문자열
- **URL** = 접근방법까지 포함한 식별자 (위치를 통해 식별하는 방식)
- **URN** = 리소스의 위치와는 상관없이 이름만을 부여하여 식별하는 방식

---

## 공유기(NAT) 작동원리

### NAT란?
**Network Address Translation** - 네트워크 주소(IP 주소) 변환
- 하나의 공인 IP 주소를 여러 개의 사설 IP 주소로 변환하는 시스템

### NAT의 필요성
- **IP 주소 고갈 문제 해결**
- 사설망을 사용하여 하나의 공인 IP 주소를 여러 개의 사설 IP 주소로 변환

### NAT 작동 원리

#### 아웃바운드 통신 (내부 → 외부)
1. 사설망 내부 PC가 외부망으로 통신을 시도하면, 패킷은 반드시 공유기(게이트웨이)를 거칩니다.
2. 이때 패킷의 출발지 IP 주소는 사설 IP 주소(예: 192.168.x.x)로 채워져 있습니다.

> **질문**: 왜 사설 IP 주소는 인터넷에서 인지할 수 없을까?  
> **답변**: 
> - 사설 IP 주소는 내부 네트워크에서만 사용하도록 예약된 주소
> - 전 세계 수많은 사설망에서 중복으로 사용
> - 사설 IP 주소를 그대로 사용하면 구분할 수 없음
> - 공인 IP 주소는 인터넷에서 통용되는 주소이므로 이를 사용해야 함

3. 공유기는 이 패킷을 받아서 출발지 IP 주소를 자신의 공인 IP 주소로 변환하고 목적지로 발신한다.
4. 외부 서버는 실제로 요청을 보낸 호스트를 내부 PC가 아닌 공유기로 인식하게 된다.

#### 인바운드 통신 (외부 → 내부)
1. 외부 서버가 응답 패킷을 보내면 도착지 IP 주소는 공유기의 공인 IP 주소로 채워져 있다.
2. 공유기는 이 패킷을 받고 NAT 테이블을 조회한다.
3. NAT 테이블에 기록된 이력을 바탕으로, 원래 이 요청을 보냈던 사설망 내부 PC의 사설 IP 주소와 포트 번호를 찾아내어, 패킷의 도착지 주소를 다시 변환하여 내부 PC로 전달합니다.

### NAT의 장점
1. **IP 주소 절약**
2. **보안성 향상**
   - 외부망에서 사설망 내부 PC로 직접 접근 불가능
   - NAT 테이블에서 해당 요청에 매칭되는 이력을 찾을 수 없으면 패킷을 자동으로 버림
   - 방화벽 기능 수행

---

## NAT 작동 원리 다이어그램

### 아웃바운드 통신 (내부 → 외부)
```
[PC 192.168.1.100] → [공유기/NAT] → [인터넷] → [웹서버]
     ↓                    ↓              ↓
  사설IP 패킷         공인IP로 변환    공인IP 패킷
  (192.168.1.100)    (203.0.113.1)   (203.0.113.1)
```

### 인바운드 통신 (외부 → 내부)
```
[웹서버] → [인터넷] → [공유기/NAT] → [PC 192.168.1.100]
    ↓           ↓           ↓              ↓
응답 패킷   공인IP 패킷   NAT테이블 조회   사설IP 패킷
(203.0.113.1) (203.0.113.1) → 변환 → (192.168.1.100)
```

